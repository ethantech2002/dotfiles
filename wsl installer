# WSL2 Multi-Distribution Installer
# Run this script as Administrator in PowerShell

#Requires -RunAsAdministrator

Write-Host "===================================================" -ForegroundColor Cyan
Write-Host "WSL2 Multi-Distribution Installation Script" -ForegroundColor Cyan
Write-Host "===================================================" -ForegroundColor Cyan
Write-Host ""

# Function to check if WSL is enabled
function Test-WSLEnabled {
    $wslFeature = Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux
    return $wslFeature.State -eq "Enabled"
}

# Function to install a WSL distribution
function Install-WSLDistro {
    param(
        [string]$DistroName,
        [string]$DisplayName
    )
    
    Write-Host "Installing $DisplayName..." -ForegroundColor Yellow
    try {
        wsl --install -d $DistroName
        if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ $DisplayName installation initiated successfully" -ForegroundColor Green
            return $true
        } else {
            Write-Host "✗ $DisplayName installation failed (Exit code: $LASTEXITCODE)" -ForegroundColor Red
            return $false
        }
    } catch {
        Write-Host "✗ Error installing $DisplayName : $_" -ForegroundColor Red
        return $false
    }
    Write-Host ""
}

# Check if running as Administrator
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

if (-not $isAdmin) {
    Write-Host "ERROR: This script must be run as Administrator!" -ForegroundColor Red
    Write-Host "Please right-click on PowerShell and select 'Run as Administrator'" -ForegroundColor Yellow
    pause
    exit 1
}

Write-Host "Checking WSL status..." -ForegroundColor Yellow
Write-Host ""

# Install distributions
$results = @{}
$results['Ubuntu-22.04'] = Install-WSLDistro -DistroName "Ubuntu-22.04" -DisplayName "Ubuntu 22.04"
$results['Kali-Linux'] = Install-WSLDistro -DistroName "kali-linux" -DisplayName "Kali Linux"
$results['Arch'] = Install-WSLDistro -DistroName "Arch" -DisplayName "Arch Linux"

Write-Host ""
Write-Host "===================================================" -ForegroundColor Cyan
Write-Host "Installation Summary" -ForegroundColor Cyan
Write-Host "===================================================" -ForegroundColor Cyan

foreach ($distro in $results.Keys) {
    $status = if ($results[$distro]) { "✓ SUCCESS" } else { "✗ FAILED" }
    $color = if ($results[$distro]) { "Green" } else { "Red" }
    Write-Host "$distro : $status" -ForegroundColor $color
}

Write-Host ""
Write-Host "===================================================" -ForegroundColor Cyan
Write-Host "NEXT STEPS" -ForegroundColor Cyan
Write-Host "===================================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Your computer needs to restart to complete the installation." -ForegroundColor Yellow
Write-Host ""
Write-Host "After rebooting:" -ForegroundColor White
Write-Host "  1. Ubuntu 22.04 will launch automatically" -ForegroundColor White
Write-Host "     → Enter your desired username and password" -ForegroundColor Gray
Write-Host ""
Write-Host "  2. Open Kali Linux from the Start Menu" -ForegroundColor White
Write-Host "     → Enter your desired username and password" -ForegroundColor Gray
Write-Host ""
Write-Host "  3. Open Arch Linux from the Start Menu" -ForegroundColor White
Write-Host "     → Enter your desired username and password" -ForegroundColor Gray
Write-Host ""
Write-Host "NOTE: All three distributions will use the username and password" -ForegroundColor Cyan
Write-Host "      you create during first launch. Root user is disabled by default." -ForegroundColor Cyan
Write-Host ""

# Ask user if they want to reboot now
$reboot = Read-Host "Do you want to reboot now? (Y/N)"

if ($reboot -eq "Y" -or $reboot -eq "y") {
    Write-Host ""
    Write-Host "Rebooting in 10 seconds..." -ForegroundColor Yellow
    Write-Host "Press Ctrl+C to cancel" -ForegroundColor Yellow
    Start-Sleep -Seconds 10
    Restart-Computer -Force
} else {
    Write-Host ""
    Write-Host "Please remember to reboot your computer manually to complete the installation." -ForegroundColor Yellow
    Write-Host ""
    pause
}
